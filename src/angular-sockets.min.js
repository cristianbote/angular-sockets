/**
  * Angular sockets module
  * This module helps bringing in the sockets, as a native extension of angularjs.
  * @author: Cristian Bote
  *
  * License: MIT, 2014
  */

!function(e,n){"use strict";n.module("ngSockets",[]).provider("$sockets",function(){var n={server:null,scope:null,started:!1,handlers:{onopen:null,onmessage:null,onclose:null},model:{type:"message",ip:null,data:null},ws:e.WebSocket||e.MozWebSocket},t=this,o=null;this.setup=function(e){n.handlers=e.handlers||n.handlers,n.scope=e.scope||n.scope,n.server=e.server||n.server,n.server&&!n.started&&t.init()},this.getModel=function(e,t){return n.model.type=t||n.model.type,n.model.ip=o,n.model.data=e,JSON.stringify(n.model)},this.init=function(){n.connection=new n.ws(n.server);for(var e in n.handlers)!function(e){n.connection[e]=function(t){var s=t.data&&-1!==t.data.indexOf("{")?JSON.parse(t.data):t.data;n.scope&&n.scope.$broadcast("$sockets:"+e,s),"function"==typeof n.handlers[e]&&n.handlers[e](s),s&&s.ip&&!o&&(o=s.ip)}}(e);n.started=!0},this.$get=function(){return{setup:t.setup,send:function(e,o){if(n.connection&&1===n.connection.readyState){var s=t.getModel(e,o);return n.connection.send(s),JSON.parse(s)}}}}})}(window,window.angular);